<html xmlns:th="http://www.thymeleaf.org">

<!-- TODO:   Thymeleaf 3.0.15 issue with binding form-objects during list-iteration: only works if there's a
     TODO:   "reference" object in the model (even though it's not the one getting bound to the form).
     TODO:   'th:field' syntax doesn't populate the inputs  -->

<div th:fragment="refProps(reference)">
    <div class="form-row">
        <div class="form-group col-6">
            <label th:for="'entailment' + ${reference.id}">Entailment</label>
            <select name="entailment" th:value="${reference.entailment}" class="form-control" th:id="'entailment' + ${reference.id}"
                    th:disabled="${!#authorization.expression('hasRole(''ROLE_CHECKER'')') or mode == 'read'}">
                <option value=""> -- </option>
                <option th:each="entailmentOpt : ${T(org.informiz.model.Reference.Entailment).values()}"
                        th:value="${entailmentOpt}" th:text="${entailmentOpt.getDisplayValue()}"
                        th:selected="${entailmentOpt.equals(reference.entailment)}"></option>
            </select>
            <span th:if="${#fields.hasErrors('entailment')}" th:errors="*{entailment}" class="text-danger"></span>
        </div>
        <div class="form-group col-6">
            <label th:for="'degree' + ${reference.id}">Degree</label>
            <input type="number" name="degree" th:value="${reference.degree}" th:id="'degree' + ${reference.id}"
                   min="0" max="1" step="0.01" class="form-control"
                   th:disabled="${!#authorization.expression('hasRole(''ROLE_CHECKER'')') or mode == 'read'}">
            <span th:if="${#fields.hasErrors('degree')}" th:errors="*{degree}" class="text-danger"></span>

        </div>
    </div>
    <div>
        <label th:for="'comment' + ${reference.id}" class="col-form-label">Comment</label>
        <textarea name="comment" class="form-control" cols="20" th:id="'comment' + ${reference.id}"
                  th:disabled="${!#authorization.expression('hasRole(''ROLE_CHECKER'')') or mode == 'read'}"
                  th:text="${reference.comment}"></textarea>
        <span th:if="${#fields.hasErrors('comment')}" th:errors="*{comment}" class="text-danger"></span>
    </div>
</div>

<div th:fragment="editRefForm(action_path, reference)">
    <form th:id="'reference_form_' + ${reference.getId()}" th:action="${action_path}" th:object="${reference}" method="post">
        <input type="text" class="d-none" name="refEntityId" th:value="${reference.getRefEntityId()}" readonly>
        <input type="text" class="d-none" name="factCheckedEntityId" th:value="${reference.getFactCheckedEntityId()}" readonly>
        <input type="text" class="d-none" name="ownerId" th:value="${reference.ownerId}" readonly>

        <div th:replace="~{fragments/reference :: refProps(${reference})}"></div>

        <div th:if="${#authorization.expression('hasRole(''ROLE_CHECKER'')')}" class="row mt-2">
            <div class="col-4">
                <input type="submit" class="btn btn-primary" value="Update">
            </div>
        </div>
        <th:block th:if="${#fields.hasAnyErrors()}">
            <!-- Display form if submission failed with errors -->
            <script>
                loadCompleteCallbacks.push(function() {
                    const form_selector = "#reference_form_" + "[[${reference.getId()}]]";
                    // trigger containing modal to display form
                    const modal_selector = "#" + $(form_selector).closest(".modal").attr("id");
                    $("button[data-bs-target='"+ modal_selector +"']").click();
                });
            </script>
        </th:block>
    </form>
</div>

<div th:fragment="referenceForm(action_path, reference, entityId)">
    <form th:id="'reference_form_' + ${reference.getId()}" th:action="${action_path}" th:object="${reference}"  method="post"
          th:data-path="${action_path}">
        <div class="form-row">
            <div class="form-group col">
                <input name="reference-select" class="form-control refAutoSelect"
                       th:disabled="${!#authorization.expression('hasRole(''ROLE_CHECKER'')') or mode == 'read'}"
                       placeholder="Start typing to search..." >
                <input type="text" class="d-none" name="refEntityId" th:value="${reference.getRefEntityId()}">
                <input type="text" class="d-none" name="factCheckedEntityId" th:value="${entityId}" readonly>
                <span th:if="${#fields.hasErrors('refEntityId')}" th:errors="*{refEntityId}" class="text-danger"></span>
            </div>
        </div>

        <div th:replace="~{fragments/reference :: refProps(${reference})}"></div>


        <div th:if="${#authorization.expression('hasRole(''ROLE_CHECKER'')')}" class="row mt-2">
            <div class="col-4">
                <input type="submit" class="btn btn-primary" value="Add">
            </div>
        </div>
        <th:block th:if="${#fields.hasAnyErrors()}">
            <!-- Display form if submission failed with errors -->
            <script>
                // Note: Thymeleaf returns the string "null" for no-id in html, but empty-string inside javascript
                const form_selector = "#reference_form_" + ("[[${reference.getId()}]]" ? "[[${reference.getId()}]]" : "null");
                const ref_entity_id = "[[${reference.getRefEntityId()}]]";

                modalCallbacks.push(function () {
                    if ( ref_entity_id ) {
                        let ref = references.find(obj => {
                            return obj.id === ref_entity_id;
                        })
                        const modal_selector = "#" + $(form_selector).closest(".modal").attr("id");
                        if (ref) {
                            // if user already chose a reference - select it when modal pops up
                            $(modal_selector).one('shown.bs.modal', function() {
                                $('.refAutoSelect').autocomplete('search', ref.label)
                                let menu = $(".refAutoSelect").autocomplete("widget");
                                let found = $(menu[0].children[0])//.click();
                                if (found) found.click();
                            });
                        }
                        // trigger containing modal to display form
                        $(modal_selector).modal('show');
                    }
                })
            </script>
        </th:block>
    </form>
</div>

