<html xmlns:th="http://www.thymeleaf.org">

<!-- TODO: can define thymeleaf "macro" to check if errors come from this form?? -->
    <div th:fragment="reviewForm(entityId, action_path, review_obj)">
        <form th:id="'rev_form_' + ${review_obj.id}" th:action="${action_path}" th:object="${review_obj}" method="post">
            <div class="form-row">
                <div class="col">
                    <input type="text" class="d-none" name="reviewedEntityId" th:value="${entityId}" readonly/>
                    <input type="text" class="d-none" name="ownerId" th:value="${review_obj.ownerId} ? ${review_obj.ownerId} : ${#authentication.principal.name}" readonly/>
                    <input type="text" class="d-none" name="id" th:value="${review_obj.id}" readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="col-4">
                    <label th:for="'rating_' + *{id}" class="col-form-label">Reliability</label>
                    <input type="number" name="rating" th:value="${review_obj.rating}" min="0" max="1" step="0.01"
                           class="form-control" th:id="'rating' + ${review_obj.id}" placeholder="0.9"/>
                    <span th:if="${#fields.hasErrors('rating') && @tlUtils.isReviewFormError(review_obj, review)}"
                          th:errors="*{rating}" class="text-danger"></span>
                </div>
                <div class="col-8">
                    <label th:for="'comment_' + *{id}" class="col-form-label">Comment</label>
                    <textarea name="comment" th:text="${review_obj.comment}" class="form-control" th:id="'comment' + ${review_obj.getId()}" cols="30"
                              placeholder="Explain your review..."></textarea>
                    <span th:if="${#fields.hasErrors('comment') && @tlUtils.isReviewFormError(review_obj, review)}"
                          th:errors="*{comment}" class="text-danger"></span>
                </div>
            </div>
            <div th:if="${#authorization.expression('hasRole(''ROLE_CHECKER'')')}" class="form-row mt-2">
                <div class="col-4">
                    <input type="submit" th:id="'rev_form_submit_' + ${review_obj.getId()}" class="btn btn-primary"
                           value="Submit">
                    </a>
                </div>
            </div>
            <th:block th:if="${#fields.hasAnyErrors() && @tlUtils.isReviewFormError(review_obj, review)}">
                <!-- Display form if submission failed with errors -->
                <th:block th:if="${@tlUtils.isAddReviewError(review_obj, review)}">
                    <script>
                        loadCompleteCallbacks.push(function() {
                            // trigger containing modal to display form
                            $("#modal_rev_0").modal('show');
                        });
                    </script>
                </th:block>
                <th:block th:unless="${@tlUtils.isAddReviewError(review_obj, review)}">
                    <script>
                        loadCompleteCallbacks.push(function() {
                            const modal_selector = "#modal_rev_" + "[[${review_obj.getId()}]]";
                            // trigger containing modal to display form
                            $(modal_selector).modal('show');
                        });
                    </script>
                </th:block>
            </th:block>
        </form>
    </div>
</html>