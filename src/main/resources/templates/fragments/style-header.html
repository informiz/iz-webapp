<html xmlns:th="http://www.thymeleaf.org">

    <div th:fragment="header">
        <nav class="navbar navbar-expand-sm navbar-light" style="background-color: #e3f2fd;">

            <div class="navbar-header">
                <a class="navbar-brand" href="#">Informiz</a>
            </div>


            <div class="collapse navbar-collapse" id="informiz-toggle-nav">
                <ul class="nav navbar-nav ml-auto">

                    <!-- TODO: Unable to show/hide buttons based on authentication state.
                         Tried th:if=${#authorization.expression('isAuthenticated()')}
                         Tried sec:authorize="isAuthenticated()" (xmlns:sec="http://www.thymeleaf.org/extras/spring-security")-->

                    <li id="signinButton" style="visibility: hidden;">
                        <a href="/login/oauth2/code/google" class="nav-item">
                                <span class="g-signin2" aria-hidden="true" data-accesstype="postmessage"
                                      data-onsuccess="onSignIn"></span>
                        </a>
                    </li>
                    <li id="signoutButton" style="visibility: hidden;">
                        <a class="btn btn-default btn-sm" onclick="signOut();">
                            <span class="glyphicon glyphicon-log-out">Sign out</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <script>

            // TODO: Fix configuration - without init buttons don't show in home page, with init 'show' is called twice
            gapi.load('auth2', function() {
                gapi.auth2.init().then(function (googleAuth) {
                    if (googleAuth.isSignedIn.get()) {
                        showLogout();
                    } else {
                        showLogin();
                    }
                },
                function () {
                    showLogin();
                });
            });


            function onSignIn(googleUser) {
                showLogout();
                // TODO: need to redirect to protected page to trigger authentication. Is there a better way?
                if (window.location.href.endsWith('/home.html')) {
                    window.location.replace('/factchecker/');
                }
            }

            function signOut() {
                var auth2 = gapi.auth2.getAuthInstance();
                auth2.signOut();
                auth2.disconnect(); // TODO: This logs the user out of gmail. Necessary?
                window.location.href = '/home.html';
            }


            function showLogin() {
                $('#signoutButton').css('visibility', 'hidden');
                $('#signinButton').css('visibility', 'visible');
            }

            function showLogout() {
                $('#signinButton').css('visibility', 'hidden');
                $('#signoutButton').css('visibility', 'visible');
            }

        </script>

    </div>
</html>
